<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Budget Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA manifest + icons -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#020617" />

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* üåû LIGHT THEME (default) */
    :root {
      --bg-page: #f3f4f6;
      --bg-shell: #e5e7eb;
      --bg-sidebar: #ffffff;
      --bg-main: radial-gradient(circle at top left, #ffffff 0, #e5e7eb 55%);
      --bg-card: #ffffff;
      --bg-card-soft: #f9fafb;
      --pill-bg: #eef2ff;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.08);
      --accent-strong: #4338ca;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-subtle: rgba(148, 163, 184, 0.6);
      --border-strong: rgba(148, 163, 184, 0.9);
      --danger: #ef4444;
      --success: #16a34a;
      --info: #2563eb;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.13);
    }

    /* üåô DARK THEME ‚Äì used when <body> has class="dark" */
    body.dark {
      --bg-page: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      --bg-shell: #020617;
      --bg-sidebar: #020617;
      --bg-main: radial-gradient(circle at top left, #111827 0, #020617 60%);
      --bg-card: #020617;
      --bg-card-soft: #020617;
      --pill-bg: rgba(79, 70, 229, 0.18);
      --accent: #6366f1;
      --accent-soft: rgba(79, 70, 229, 0.16);
      --accent-strong: #4f46e5;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.4);
      --border-strong: rgba(148, 163, 184, 0.7);
      --danger: #f97373;
      --success: #22c55e;
      --info: #3b82f6;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    /* üîê NEVER wider than screen */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    body {
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 12px;
    }

    .app-shell {
      width: 100%;
      max-width: 1120px;
      border-radius: 20px;
      overflow: hidden;
      background: var(--bg-shell);
      display: grid;
      grid-template-columns: 64px minmax(0, 1fr);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-subtle);
    }

    @media (max-width: 880px) {
      .app-shell {
        grid-template-columns: 1fr;
        grid-template-rows: auto minmax(0, 1fr);
        border-radius: 0;
      }
    }

    /* SIDEBAR */
    .sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-subtle);
      padding: 10px 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    @media (max-width: 880px) {
      .sidebar {
        flex-direction: row;
        justify-content: space-between;
        border-right: none;
        border-bottom: 1px solid var(--border-subtle);
        padding: 8px 8px;
      }
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: radial-gradient(circle at 20% 20%, #6366f1, #4f46e5 40%, #020617 95%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7ff;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 8px 18px rgba(79, 70, 229, 0.55);
      flex-shrink: 0;
    }

    .sidebar-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    @media (max-width: 880px) {
      .sidebar-col {
        flex-direction: row;
        justify-content: flex-start;
      }
    }

    .nav-wrapper { position: relative; }

    .nav-list {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    @media (max-width: 880px) {
      .nav-list {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      border-radius: 14px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      background: var(--accent-soft);
      color: var(--accent-strong);
      box-shadow: 0 6px 14px rgba(79, 70, 229, 0.4);
    }

    .nav-btn.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      box-shadow: 0 6px 14px rgba(79, 70, 229, 0.45);
    }

    .nav-indicator {
      position: absolute;
      left: 0;
      width: 3px;
      height: 26px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--accent), var(--accent-strong));
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
      transform: translateY(0);
      transition: transform 0.25s;
    }

    @media (max-width: 880px) {
      .nav-indicator {
        top: 100%;
        height: 3px;
        width: 30px;
      }
    }

    .sidebar-bottom {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 880px) {
      .sidebar-bottom {
        flex-direction: row;
        justify-content: flex-end;
      }
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.28);
      display: inline-block;
    }

    .pill-small {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--pill-bg);
      border: 1px solid var(--border-subtle);
      font-size: 10px;
      max-width: 120px;
      text-align: left;
    }

    .main-area {
      background: var(--bg-main);
      padding: 12px 12px 18px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .panel { background: transparent; }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .topbar-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .topbar-main span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .field { margin-top: 8px; }

    label {
      display: block;
      margin-bottom: 3px;
      font-size: 11px;
      color: var(--text-muted);
    }

    input, select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-card-soft);
      color: var(--text-main);
      font-size: 13px;
    }

    input::placeholder { color: rgba(148, 163, 184, 0.9); }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.4);
    }

    .row { display: flex; gap: 8px; }
    .row > .field { flex: 1; }

    @media (max-width: 640px) { .row { flex-direction: column; } }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      box-shadow: 0 8px 18px rgba(79, 70, 229, 0.5);
      width: 100%;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border-subtle);
      box-shadow: none;
      color: var(--text-muted);
      width: auto;
      padding-inline: 10px;
      font-size: 12px;
    }

    .btn-small { padding: 5px 9px; font-size: 11px; }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow: 0 6px 14px rgba(239, 68, 68, 0.55);
      width: auto;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .section-title {
      margin-top: 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: var(--text-muted);
    }

    .divider {
      height: 1px;
      background: radial-gradient(circle, var(--border-strong), transparent);
      margin: 5px 0 8px;
      border-radius: 999px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    @media (max-width: 720px) { .summary-grid { grid-template-columns: 1fr; } }

    .summary-tile {
      border-radius: 14px;
      padding: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
    }

    .summary-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .summary-value {
      margin-top: 4px;
      font-size: 18px;
      font-weight: 600;
    }

    .summary-tag { margin-top: 3px; font-size: 10px; }

    .summary-income { color: var(--success); }
    .summary-expense { color: var(--danger); }
    .summary-balance { color: var(--info); }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 190px;
      overflow-y: auto;
    }

    li.expense-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 11px;
      background: var(--bg-card);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 11px;
      margin-top: 4px;
    }

    .expense-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      max-width: 70%;
    }

    .expense-title { font-weight: 500; }

    .expense-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    .expense-amount {
      font-weight: 600;
      white-space: nowrap;
      font-size: 12px;
    }

    .goal-wrapper { margin-top: 4px; }

    .goal-pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 10px;
      background: var(--pill-bg);
      border: 1px solid var(--border-subtle);
      display: inline-flex;
      gap: 5px;
      align-items: center;
    }

    .goal-bar {
      height: 6px;
      border-radius: 999px;
      background: var(--bg-card-soft);
      overflow: hidden;
      margin-top: 4px;
    }

    .goal-bar-inner {
      height: 100%;
      background: linear-gradient(90deg, var(--success), #22c55e);
    }

    .chart-container {
      margin-top: 6px;
      background: var(--bg-card);
      border-radius: 14px;
      padding: 6px;
      border: 1px solid var(--border-subtle);
    }

    .auth-card {
      max-width: 520px;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 12px 12px 14px;
      border: 1px solid var(--border-subtle);
    }

    @media (max-width: 480px) {
      body { padding: 0; }
      .main-area { padding: 10px 8px 14px; }
      .auth-card { border-radius: 0; max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-col">
        <div class="logo-mark">SB</div>

        <div class="nav-wrapper">
          <div class="nav-list" id="navList">
            <button class="nav-btn active" data-target="section-overview"
              onclick="scrollToSection('section-overview')" title="Overview">üìä</button>
            <button class="nav-btn" data-target="section-goal"
              onclick="scrollToSection('section-goal')" title="Savings goal">üéØ</button>
            <button class="nav-btn" data-target="section-expense"
              onclick="scrollToSection('section-expense')" title="Add expense">üí∏</button>
            <button class="nav-btn" data-target="section-history"
              onclick="scrollToSection('section-history')" title="History & analytics">üìö</button>
            <button class="nav-btn" data-target="section-export"
              onclick="scrollToSection('section-export')" title="Export report">üìÑ</button>
          </div>
          <div class="nav-indicator" id="navIndicator"></div>
        </div>
      </div>

      <div class="sidebar-bottom">
        <div class="pill-small">
          <span class="badge-dot"></span>
          <span id="sidebarStatus">No student</span>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button class="btn-ghost btn-small" onclick="switchTheme()" title="Toggle theme">
            <span id="themeIcon">üåô</span>
          </button>
          <button class="btn-ghost btn-small" onclick="logout()" title="Sign out">‚èè</button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-area">
      <!-- AUTH -->
      <div class="panel" id="authSection">
        <div class="topbar">
          <div class="topbar-main">
            <strong>Student sign-in</strong>
            <span>Each student gets their own budget dashboard on this device.</span>
          </div>
        </div>

        <div class="auth-card">
          <div class="row">
            <div class="field">
              <label>Sign in ‚Äì Username</label>
              <input id="loginUsername" placeholder="e.g. rahul12" />
              <label style="margin-top:8px;">PIN</label>
              <input id="loginPin" maxlength="4" type="password" placeholder="4 digits" />
              <div class="field">
                <button onclick="loginStudent()">Sign in</button>
              </div>
            </div>

            <div class="field" style="flex:0.1; align-self:center; text-align:center; font-size:11px; color:var(--text-muted);">
              OR
            </div>

            <div class="field">
              <label>New student ‚Äì Username</label>
              <input id="regUsername" placeholder="e.g. sneha08" />
              <label style="margin-top:8px;">Create PIN</label>
              <input id="regPin" maxlength="4" type="password" placeholder="4 digits" />
              <div class="field">
                <button onclick="registerStudent()">Register</button>
              </div>
            </div>
          </div>
          <p class="hint">
            Data is stored only in this browser using local storage.
          </p>
        </div>
      </div>

      <!-- STUDENT APP -->
      <div class="panel" id="studentSection" style="display:none;">
        <!-- OVERVIEW -->
        <section id="section-overview">
          <div class="topbar">
            <div class="topbar-main">
              <div>
                <span class="badge-dot" style="margin-right:6px;"></span>
                <strong id="studentWelcome"></strong>
              </div>
              <span>Dashboard for your monthly student budget.</span>
            </div>
          </div>

          <div class="section-title">Monthly overview</div>
          <div class="divider"></div>

          <div class="row">
            <div class="field">
              <label>Monthly income (pocket money / stipend)</label>
              <input type="number" id="incomeInput" placeholder="Amount in ‚Çπ" />
            </div>
            <div class="field" style="align-self:flex-end;">
              <button onclick="setIncome()">Save income</button>
            </div>
          </div>

          <div class="summary-grid">
            <div class="summary-tile">
              <div class="summary-label">Total income</div>
              <div class="summary-value summary-income">‚Çπ <span id="income">0</span></div>
              <div class="summary-tag">Money coming in this month</div>
            </div>
            <div class="summary-tile">
              <div class="summary-label">Total expenses</div>
              <div class="summary-value summary-expense">‚Çπ <span id="expense">0</span></div>
              <div class="summary-tag">Spend across all categories</div>
            </div>
            <div class="summary-tile">
              <div class="summary-label">Available balance</div>
              <div class="summary-value summary-balance">‚Çπ <span id="balance">0</span></div>
              <div class="summary-tag">Income minus expenses</div>
            </div>
          </div>
        </section>

        <!-- GOAL -->
        <section id="section-goal">
          <div class="section-title">Savings goal</div>
          <div class="divider"></div>
          <div class="row">
            <div class="field">
              <label>Goal name</label>
              <input id="goalName" placeholder="Example: Phone upgrade, exam fees, trip" />
            </div>
            <div class="field">
              <label>Target amount (‚Çπ)</label>
              <input type="number" id="goalTarget" placeholder="e.g. 5000" />
            </div>
            <div class="field" style="align-self:flex-end;">
              <button onclick="setGoal()">Save goal</button>
            </div>
          </div>
          <div id="goalsList" class="goal-wrapper"></div>
        </section>

        <!-- ADD EXPENSE -->
        <section id="section-expense">
          <div class="section-title">Add expense</div>
          <div class="divider"></div>
          <div class="field">
            <label>Title</label>
            <input id="title" placeholder="Example: Canteen lunch, tuition, bus pass" />
          </div>
          <div class="row">
            <div class="field">
              <label>Amount (‚Çπ)</label>
              <input type="number" id="amount" placeholder="Enter amount" />
            </div>
            <div class="field">
              <label>Category</label>
              <select id="category">
                <option>Food</option>
                <option>Transport</option>
                <option>Study</option>
                <option>Entertainment</option>
                <option>Mobile/Data</option>
                <option>Merchant payment</option>
                <option>Others</option>
              </select>
            </div>
            <div class="field">
              <label>Date</label>
              <input type="date" id="date" />
            </div>
          </div>
          <div class="field">
            <button onclick="addExpense()">Add expense</button>
          </div>
        </section>

        <!-- HISTORY -->
        <section id="section-history">
          <div class="section-title">History & analytics</div>
          <div class="divider"></div>
          <div class="row" style="align-items:flex-end; margin-bottom:4px;">
            <div class="field">
              <label>From date</label>
              <input type="date" id="filterStart" onchange="updateStudentUI()" />
            </div>
            <div class="field">
              <label>To date</label>
              <input type="date" id="filterEnd" onchange="updateStudentUI()" />
            </div>
            <div class="field">
              <button class="btn-ghost" onclick="clearFilters()">Clear</button>
            </div>
          </div>

          <div class="row">
            <div class="field" style="flex:1.3;">
              <label style="font-size:11px; color:var(--text-muted);">Spending by category</label>
              <div class="chart-container">
                <canvas id="categoryChart" height="190"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- EXPORT -->
        <section id="section-export">
          <div class="section-title">Export</div>
          <div class="divider"></div>
          <div class="row" style="align-items:center;">
            <div class="field">
              <button onclick="exportStudentPDF()">Download monthly report (PDF)</button>
              <p class="hint">
                One-page PDF with your income, spending, balance, goal progress and recent transactions.
              </p>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const STORAGE_KEY = "studentBudgetApp_sidebar_v2";
    const ACTIVE_USER_KEY = "activeStudentUser_sidebar_v2";

    let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { students: {} };
    if (!appData.students) appData.students = {};
    let currentUser = localStorage.getItem(ACTIVE_USER_KEY) || null;
    let studentChart = null;

    function saveApp() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    function getActiveStudent() {
      if (!currentUser) return null;
      return appData.students[currentUser] || null;
    }

    function applyTheme(theme) {
      const isDark = theme === "dark";
      document.body.classList.toggle("dark", isDark);
      const icon = document.getElementById("themeIcon");
      if (icon) icon.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    }

    function updateSidebarStatus() {
      const status = document.getElementById("sidebarStatus");
      status.textContent = currentUser || "No student";
    }

    function updateNavIndicator() {
      const indicator = document.getElementById("navIndicator");
      const activeBtn = document.querySelector(".nav-btn.active");
      const navList = document.getElementById("navList");
      if (!indicator || !activeBtn || !navList) return;

      const isMobile = window.innerWidth <= 880;
      if (!isMobile) {
        const offset = activeBtn.offsetTop - navList.offsetTop +
          (activeBtn.offsetHeight - indicator.offsetHeight) / 2;
        indicator.style.transform = `translateY(${offset}px)`;
      } else {
        const width = activeBtn.offsetWidth * 0.7;
        indicator.style.width = width + "px";
        const offset = activeBtn.offsetLeft - navList.offsetLeft +
          (activeBtn.offsetWidth - width) / 2;
        indicator.style.transform = `translateX(${offset}px)`;
      }
    }

    function scrollToSection(id) {
      const section = document.getElementById(id);
      if (section) section.scrollIntoView({ behavior: "smooth", block: "start" });

      document.querySelectorAll(".nav-btn").forEach(btn => {
        const target = btn.getAttribute("data-target");
        btn.classList.toggle("active", target === id);
      });
      setTimeout(updateNavIndicator, 60);
    }

    window.addEventListener("resize", () => setTimeout(updateNavIndicator, 60));

    // AUTH
    function registerStudent() {
      const username = document.getElementById("regUsername").value.trim();
      const pin = document.getElementById("regPin").value.trim();

      if (!username || !pin || pin.length !== 4 || !/^[0-9]{4}$/.test(pin)) {
        alert("Enter a username and a 4-digit numeric PIN.");
        return;
      }
      if (appData.students[username]) {
        alert("That student username is already in use.");
        return;
      }

      appData.students[username] = {
        pin,
        theme: "dark",
        income: 0,
        expenses: [],
        goals: []
      };
      saveApp();

      currentUser = username;
      localStorage.setItem(ACTIVE_USER_KEY, currentUser);

      document.getElementById("regUsername").value = "";
      document.getElementById("regPin").value = "";

      showStudentApp();
    }

    function loginStudent() {
      const username = document.getElementById("loginUsername").value.trim();
      const pin = document.getElementById("loginPin").value.trim();

      if (!appData.students[username]) {
        alert("Student not found. Please register first.");
        return;
      }
      if (appData.students[username].pin !== pin) {
        alert("Incorrect PIN.");
        return;
      }

      currentUser = username;
      localStorage.setItem(ACTIVE_USER_KEY, currentUser);

      document.getElementById("loginUsername").value = "";
      document.getElementById("loginPin").value = "";

      showStudentApp();
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem(ACTIVE_USER_KEY);
      document.getElementById("authSection").style.display = "block";
      document.getElementById("studentSection").style.display = "none";
      applyTheme("light");
      updateSidebarStatus();
      scrollToSection("section-overview");
    }

    function showStudentApp() {
      const student = getActiveStudent();
      if (!student) return;

      document.getElementById("authSection").style.display = "none";
      document.getElementById("studentSection").style.display = "block";

      document.getElementById("studentWelcome").innerText = "Welcome, " + currentUser;
      updateSidebarStatus();
      applyTheme(student.theme || "dark");
      scrollToSection("section-overview");
      updateStudentUI();
    }

    function switchTheme() {
      const student = getActiveStudent();
      if (!student) {
        const isDark = !document.body.classList.contains("dark");
        applyTheme(isDark ? "dark" : "light");
        return;
      }
      student.theme = student.theme === "dark" ? "light" : "dark";
      saveApp();
      applyTheme(student.theme);
    }

    // STUDENT LOGIC
    function setIncome() {
      const student = getActiveStudent();
      if (!student) return;

      const value = Number(document.getElementById("incomeInput").value);
      if (isNaN(value) || value < 0) {
        alert("Enter a valid income amount.");
        return;
      }
      student.income = value;
      saveApp();
      updateStudentUI();
    }

    function setGoal() {
      const student = getActiveStudent();
      if (!student) return;

      const name = document.getElementById("goalName").value.trim();
      const target = Number(document.getElementById("goalTarget").value);

      if (!name || isNaN(target) || target <= 0) {
        alert("Enter a goal name and positive target amount.");
        return;
      }

      student.goals = [{ name, target }];
      saveApp();

      document.getElementById("goalName").value = "";
      document.getElementById("goalTarget").value = "";

      updateStudentUI();
    }

    function addExpense() {
      const student = getActiveStudent();
      if (!student) return;

      const title = document.getElementById("title").value.trim();
      const amountValue = Number(document.getElementById("amount").value);
      const category = document.getElementById("category").value;
      let date = document.getElementById("date").value;

      if (!title || isNaN(amountValue) || amountValue <= 0) {
        alert("Enter a title and a valid amount.");
        return;
      }

      if (!date) {
        const today = new Date();
        date = today.toISOString().slice(0, 10);
      }

      student.expenses.push({ title, amount: amountValue, category, date });

      document.getElementById("title").value = "";
      document.getElementById("amount").value = "";
      document.getElementById("date").value = "";

      saveApp();
      updateStudentUI();
    }

    function deleteExpense(index) {
      const student = getActiveStudent();
      if (!student) return;
      student.expenses.splice(index, 1);
      saveApp();
      updateStudentUI();
    }

    function clearFilters() {
      document.getElementById("filterStart").value = "";
      document.getElementById("filterEnd").value = "";
      updateStudentUI();
    }

    function getFilteredExpenses(student) {
      const start = document.getElementById("filterStart").value;
      const end = document.getElementById("filterEnd").value;
      if (!start && !end) return student.expenses;

      return student.expenses.filter(e => {
        if (start && e.date < start) return false;
        if (end && e.date > end) return false;
        return true;
      });
    }

    function updateStudentUI() {
      const student = getActiveStudent();
      if (!student) return;

      const totalExpense = student.expenses.reduce((sum, item) => sum + item.amount, 0);
      const balance = (student.income || 0) - totalExpense;

      document.getElementById("income").innerText = student.income || 0;
      document.getElementById("expense").innerText = totalExpense;
      document.getElementById("balance").innerText = balance;

      // goal
      const goalsList = document.getElementById("goalsList");
      goalsList.innerHTML = "";
      if (student.goals && student.goals.length > 0) {
        const goal = student.goals[0];
        const saved = Math.max(0, balance);
        const pct = Math.min(100, Math.round((saved / goal.target) * 100));
        const div = document.createElement("div");
        div.innerHTML = `
          <div class="goal-pill">
            <span>${goal.name}</span>
            <span>‚Ä¢ Target ‚Çπ${goal.target}</span>
          </div>
          <div style="font-size:10px; color:var(--text-muted); margin-top:4px;">
            Saved ‚Çπ${saved} (${pct}% towards goal)
          </div>
          <div class="goal-bar">
            <div class="goal-bar-inner" style="width:${pct}%;"></div>
          </div>`;
        goalsList.appendChild(div);
      }

      // list
      const filtered = getFilteredExpenses(student);
      const list = document.getElementById("list");
      list.innerHTML = "";

      filtered
        .map((item, idx) => ({ item, idx }))
        .reverse()
        .forEach(({ item, idx }) => {
          const li = document.createElement("li");
          li.className = "expense-row";
          const realIndex = idx;
          li.innerHTML = `
            <div class="expense-main">
              <div class="expense-title">${item.title}</div>
              <div class="expense-meta">${item.category} ‚Ä¢ ${item.date}</div>
            </div>
            <div style="text-align:right;">
              <div class="expense-amount">‚Çπ${item.amount}</div>
              <button class="btn-ghost btn-small btn-danger" onclick="deleteExpense(${realIndex})">Del</button>
            </div>`;
          list.appendChild(li);
        });

      // chart
      const categoryMap = {};
      student.expenses.forEach(e => {
        categoryMap[e.category] = (categoryMap[e.category] || 0) + e.amount;
      });

      const labels = Object.keys(categoryMap);
      const data = Object.values(categoryMap);
      const ctx = document.getElementById("categoryChart").getContext("2d");

      if (studentChart) studentChart.destroy();
      studentChart = new Chart(ctx, {
        type: "doughnut",
        data: { labels, datasets: [{ data }] },
        options: {
          plugins: {
            legend: {
              labels: {
                color: getComputedStyle(document.body).getPropertyValue("--text-muted") || "#9ca3af",
                font: { size: 10 }
              },
              position: "bottom"
            }
          }
        }
      });
    }

    function exportStudentPDF() {
      const student = getActiveStudent();
      if (!student) return;

      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("PDF library failed to load. Refresh with internet on.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "mm", "a4");

      const totalExpense = student.expenses.reduce((s, e) => s + e.amount, 0);
      const balance = (student.income || 0) - totalExpense;

      let y = 12;
      doc.setFontSize(16);
      doc.text("Student Budget Report", 10, y); y += 7;

      doc.setFontSize(11);
      doc.text("Student: " + currentUser, 10, y); y += 6;
      doc.text("Income: ‚Çπ" + (student.income || 0), 10, y); y += 6;
      doc.text("Total expenses: ‚Çπ" + totalExpense, 10, y); y += 6;
      doc.text("Balance: ‚Çπ" + balance, 10, y); y += 8;

      if (student.goals && student.goals.length > 0) {
        const goal = student.goals[0];
        const saved = Math.max(0, balance);
        const pct = Math.min(100, Math.round((saved / goal.target) * 100));
        doc.text(
          "Goal: " + goal.name +
          " | Target: ‚Çπ" + goal.target +
          " | Saved: ‚Çπ" + saved +
          " (" + pct + "%)",
          10,
          y
        );
        y += 9;
      }

      doc.setFontSize(12);
      doc.text("Recent expenses", 10, y); y += 6;
      doc.setFontSize(10);

      const recent = student.expenses.slice(-20).reverse();
      recent.forEach(e => {
        if (y > 280) { doc.addPage(); y = 12; }
        const line = `${e.date} - ${e.title} [${e.category}]  ‚Çπ${e.amount}`;
        doc.text(line, 10, y);
        y += 5;
      });

      doc.save(`budget-report-${currentUser}.pdf`);
    }

    // INIT + SERVICE WORKER
    window.onload = function () {
      if (currentUser && appData.students[currentUser]) {
        showStudentApp();
      } else {
        document.getElementById("authSection").style.display = "block";
        document.getElementById("studentSection").style.display = "none";
        applyTheme("light");
        updateSidebarStatus();
        setTimeout(updateNavIndicator, 80);
      }

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(console.error);
      }
    };
  </script>
</body>
</html>
